@attribute [StreamRendering]
@inject DatabaseContext DatabaseContext

<div id="@WrapperId">
    <ToDoModal ModalConfig="@BuildModalConfig(Guid.Empty)">
        <ModalTrigger>
            <div class="row mt-3">
                <div class="col">
                    <button type="button" data-bs-toggle="modal" data-bs-target="#@BuildModalConfig(Guid.Empty).Id" class="btn btn-lg btn-primary">
                        Create New ToDo
                    </button>
                </div>
            </div>
        </ModalTrigger>
    </ToDoModal>
    <hr />

    @if (toDos == null)
    {
        // Good spinner code <strong role="status">Loading... <span class="spinner-border" aria-hidden="true"></span></strong>
    }
    else if (toDos.Any())
    {
        foreach (var toDo in toDos)
        {
            var modalConfig = BuildModalConfig(toDo.Id);

            <div class="row">
                <ToDoModal ModalConfig="modalConfig" Model="toDo">
                    <ModalTrigger>
                        <button type="button" data-bs-toggle="modal" data-bs-target="#@modalConfig.Id" class="btn btn-primary">
                            Edit
                        </button>
                    </ModalTrigger>
                </ToDoModal>
            </div>
        }
    }
</div>

@code {
    private List<ToDoDto>? toDos = null;

    [Parameter]
    [EditorRequired]
    public required Guid UserId { get; set; }

    public static string WrapperId = "toDos";

    protected override async Task OnInitializedAsync()
    {
        var entities = await DatabaseContext.ToDos
            .Where(t => t.UserId == UserId)
            // Reaplace with dynamic sorting
            .OrderByDescending(dto => dto.CreateDate)
            .Select(t => new ToDo
            {
                Id = t.Id,
                Title = t.Title,
                ToDoItems = t.ToDoItems
                    .OrderBy(i => i.SortOrder)
                    .Select(i => new ToDoItem
                    {
                        Id = i.Id,
                        Description = i.Description,
                        Status = i.Status
                    })
                    .ToList()
            })
            .ToListAsync();

        toDos = entities.ConvertAll(Mapper.MapToDo);
    }
}
